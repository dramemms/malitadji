<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte carburant Mali</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #map {
      height: 100vh;
      width: 100%;
    }

    .top-bar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 10px 14px;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }

    .filters {
      position: absolute;
      top: 70px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      width: 240px;
      font-size: 14px;
    }

    .filters label { font-weight: bold; }
    .filters select { width: 100%; margin: 4px 0 8px 0; }

    .filters button {
      width: 100%;
      background: #1e3a8a;
      color: white;
      border: none;
      padding: 6px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }

    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }

    .legend span {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
    }
  </style>
</head>

<body>

<div class="top-bar">
  üõ¢Ô∏è Disponibilit√© du carburant ‚Äî Bamako & R√©gions
</div>

<div class="filters">
  <form method="get">
    <label>R√©gion</label>
    <select name="region" id="id_region" data-selected="{{ region_selected }}">
      <option value="" {% if not region_selected %}selected{% endif %}>Toutes</option>
      {% for r in regions %}
      <option value="{{ r.id }}"
        {% if r.id|stringformat:"s" == region_selected %}selected{% endif %}>
        {{ r.nom }}
      </option>
      {% endfor %}
    </select>

    <label>Cercle</label>
    <select name="cercle" id="id_cercle" data-selected="{{ cercle_selected }}">
      <option value="" {% if not cercle_selected %}selected{% endif %}>Tous</option>
      {% for ce in cercles %}
      <option value="{{ ce.id }}"
        {% if ce.id|stringformat:"s" == cercle_selected %}selected{% endif %}>
        {{ ce.nom }}
      </option>
      {% endfor %}
    </select>

    <label>Commune</label>
    <select name="commune" id="id_commune" data-selected="{{ commune_selected }}">
      <option value="" {% if not commune_selected %}selected{% endif %}>Toutes</option>
      {% for c in communes %}
      <option value="{{ c.id }}"
        {% if c.id|stringformat:"s" == commune_selected %}selected{% endif %}>
        {{ c.nom }}
      </option>
      {% endfor %}
    </select>

    <label>Statut</label>
    <select name="statut">
      <option value="" {% if not statut_selected %}selected{% endif %}>Tous</option>
      <option value="dispo" {% if statut_selected == "dispo" %}selected{% endif %}>Disponible</option>
      <option value="faible" {% if statut_selected == "faible" %}selected{% endif %}>Faible</option>
      <option value="rupture" {% if statut_selected == "rupture" %}selected{% endif %}>Rupture</option>
    </select>

    <button type="submit">Appliquer</button>
  </form>
</div>

<div id="map"></div>

<div class="legend">
  <div><span style="background:green"></span>Disponible</div>
  <div><span style="background:orange"></span>Faible</div>
  <div><span style="background:red"></span>Rupture</div>
  <div><span style="background:gray"></span>Inconnu</div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// ===================
// CARTE LEAFLET
// ===================
var map = L.map('map').setView([12.65, -8.0], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

// DATA Django vers JS
var stations = JSON.parse('{{ stations_json|escapejs }}');

function getColor(essence, gasoil) {
  if (essence === 'rupture' || gasoil === 'rupture') return 'red';
  if (essence === 'faible'  || gasoil === 'faible')  return 'orange';
  if (essence === 'dispo'   || gasoil === 'dispo')   return 'green';
  return 'gray';
}

var bounds = [];

stations.forEach(function(s) {
  if (!s.lat || !s.lng) return;

  var color = getColor(s.essence_statut, s.gasoil_statut);

  var marker = L.circleMarker([s.lat, s.lng], {
    radius: 7,
    color: color,
    fillColor: color,
    fillOpacity: 0.9
  }).addTo(map);

  marker.bindPopup(`
    <b>${s.nom}</b><br>
    R√©gion: ${s.region || "-"}<br>
    Cercle: ${s.cercle || "-"}<br>
    Commune: ${s.commune || "-"}<br><br>
    Essence: ${s.essence_statut || "-"}<br>
    Gasoil: ${s.gasoil_statut || "-"}<br><br>
    <a href="/manager/">üîê Espace g√©rant</a>
  `);

  bounds.push([s.lat, s.lng]);
});

if (bounds.length > 0) {
  map.fitBounds(bounds, {padding:[30,30]});
}
</script>

<script>
// ===================
// FILTRES DYNAMIQUES
// ===================
const cerclesData = JSON.parse('{{ cercles_json|escapejs }}');
const communesData = JSON.parse('{{ communes_json|escapejs }}');

const regionSelect  = document.getElementById('id_region');
const cercleSelect  = document.getElementById('id_cercle');
const communeSelect = document.getElementById('id_commune');

// Valeurs s√©lectionn√©es initiales
const selectedRegion  = regionSelect.dataset.selected || "";
const selectedCercle  = cercleSelect.dataset.selected || "";
const selectedCommune = communeSelect.dataset.selected || "";

// Remplit le select "Cercle" en fonction de la r√©gion
function populateCercles(regionId, keepSelected = true) {
  const currentSelected = keepSelected ? selectedCercle : "";

  cercleSelect.innerHTML = "";
  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "Tous";
  cercleSelect.appendChild(optAll);

  cerclesData.forEach(function(ce) {
    if (regionId && String(ce.region_id) !== String(regionId)) {
      return;
    }
    const opt = document.createElement("option");
    opt.value = ce.id;
    opt.textContent = ce.nom;

    if (currentSelected && String(ce.id) === String(currentSelected)) {
      opt.selected = true;
    }

    cercleSelect.appendChild(opt);
  });
}

// Remplit le select "Commune" en fonction de la r√©gion + cercle
function populateCommunes(regionId, cercleId, keepSelected = true) {
  const currentSelected = keepSelected ? selectedCommune : "";

  communeSelect.innerHTML = "";
  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "Toutes";
  communeSelect.appendChild(optAll);

  communesData.forEach(function(c) {
    // Filtre par cercle en priorit√©
    if (cercleId && String(c.cercle_id) !== String(cercleId)) {
      return;
    }

    // Si pas de cercle mais r√©gion s√©lectionn√©e, filtrer via cercle -> region
    if (!cercleId && regionId) {
      const cercle = cerclesData.find(ce => String(ce.id) === String(c.cercle_id));
      if (!cercle || String(cercle.region_id) !== String(regionId)) {
        return;
      }
    }

    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.nom;

    if (currentSelected && String(c.id) === String(currentSelected)) {
      opt.selected = true;
    }

    communeSelect.appendChild(opt);
  });
}

// Quand la r√©gion change -> on met √† jour cercle + commune
regionSelect.addEventListener('change', function() {
  const regionId = this.value || "";
  populateCercles(regionId, false);
  populateCommunes(regionId, cercleSelect.value, false);
});

// Quand le cercle change -> on met √† jour les communes
cercleSelect.addEventListener('change', function() {
  const cercleId = this.value || "";
  const regionId = regionSelect.value || "";
  populateCommunes(regionId, cercleId, false);
});

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
  populateCercles(selectedRegion, true);
  populateCommunes(selectedRegion, selectedCercle, true);
});
</script>

</body>
</html>
