<!-- stations/templates/stations/carte.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Malitadji ‚Äì Carte carburant Mali</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#020617" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#020617;
      --panel:#0b1220;
      --line: rgba(148,163,184,.28);
      --text:#e5e7eb;
      --muted:#9ca3af;

      --card:#ffffff;
      --cardText:#111827;

      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);
      --safeLeft: env(safe-area-inset-left);
      --safeRight: env(safe-area-inset-right);

      --topbarH: 64px;

      --brandGreen1:#22c55e;
      --brandGreen2:#16a34a;
      --brandGreen3:#15803d;
      --brandBlue:#1e3a8a;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow:hidden;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }
    a{color:inherit;text-decoration:none}

    .app{
      position:fixed;
      inset:0;
      display:flex;
      flex-direction:column;
      padding-left: var(--safeLeft);
      padding-right: var(--safeRight);
    }

    /* ===== Topbar ===== */
    .topbar{
      position:sticky;
      top:0;
      z-index: 4000;
      height: calc(var(--topbarH) + var(--safeTop));
      padding: calc(10px + var(--safeTop)) 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(to right, rgba(2,6,23,.98), rgba(2,6,23,.82));
      border-bottom: 1px solid rgba(15,23,42,.95);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{
      width:32px;height:32px;border-radius:12px;
      background: radial-gradient(circle at 30% 20%, var(--brandGreen1), var(--brandGreen2), var(--brandGreen3));
      display:grid;place-items:center;
      color:#022c22;font-weight:900;flex:0 0 auto;
    }
    .brand-title{min-width:0;display:flex;flex-direction:column;gap:2px}
    .brand-title strong{
      font-size:14px;font-weight:900;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .brand-title span{
      font-size:11px;color:var(--muted);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .top-actions{display:flex;gap:8px;flex:0 0 auto}
    .icon-btn{
      width:44px;height:44px;border-radius:14px;
      border:1px solid var(--line);
      background: rgba(15,23,42,.65);
      color: var(--text);
      display:grid;place-items:center;
      cursor:pointer;font-weight:900;
      user-select:none;
    }

    /* ===== Map ===== */
    .map-wrap{
      position:relative;
      flex:1;
      min-height:0;
    }
    #map{
      position:absolute;
      inset:0;
      height:100%;
      width:100%;
      background: var(--panel);
      z-index: 1;
    }

    /* ===== Legend (compact + collapsible) ===== */
    .legend{
      position:absolute;
      z-index: 2500;
      left: 12px;
      top: 12px;
      background: rgba(255,255,255,.96);
      color: #111827;
      border-radius: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,.22);
      border: 1px solid rgba(148,163,184,.35);
      padding: 10px 12px;
      font-size: 13px;
      max-width: 220px;
      user-select:none;
    }
    .legend .head{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      font-weight:900;
      margin-bottom:6px;
    }
    .legend .toggle{
      width:30px;height:30px;border-radius:10px;
      border:1px solid rgba(148,163,184,.45);
      background:#fff;
      display:grid;place-items:center;
      cursor:pointer;
      font-weight:900;
    }
    .legend .rows{display:block}
    .legend.collapsed .rows{display:none}
    .legend .row{display:flex;align-items:center;gap:8px;margin:5px 0}
    .legend .dot{width:12px;height:12px;border-radius:999px;display:inline-block}
    .dot.ok{background:green}
    .dot.warn{background:orange}
    .dot.bad{background:red}
    .dot.unk{background:gray}

    /* ===== Mini buttons (discrets) ===== */
    .mini-fab{
      position:absolute;
      right: 12px;
      bottom: calc(12px + var(--safeBottom));
      z-index: 3600;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .mini-fab .mini-btn{
      height: 44px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.35);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      background: rgba(255,255,255,.96);
      color:#0f172a;
      font-weight: 900;
      cursor:pointer;
    }
    .mini-fab .mini-btn.primary{
      background: var(--brandBlue);
      color:#fff;
      border-color: rgba(255,255,255,.10);
    }

    /* ===== Mini panel (coin) ===== */
    .mini-panel{
      position:absolute;
      right: 12px;
      bottom: calc(68px + var(--safeBottom));
      z-index: 3700;

      width: min(320px, calc(100vw - 24px));
      background: rgba(255,255,255,.98);
      color:#111827;
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(0,0,0,.30);
      border: 1px solid rgba(148,163,184,.35);

      overflow:hidden;
      display:none;
    }
    .mini-panel.open{ display:block; }

    .mini-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      background:#fff;
      border-bottom: 1px solid rgba(148,163,184,.28);
    }
    .mini-title{ font-weight:1000; font-size: 13px; }

    .mini-close{
      width:38px;height:38px;border-radius:14px;
      border:1px solid rgba(148,163,184,.45);
      background:#fff;
      display:grid;place-items:center;
      font-weight:900;
      cursor:pointer;
    }

    .mini-body{
      padding: 10px 12px 12px;
      max-height: min(56vh, 420px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .mini-body label{
      font-weight: 900;
      font-size: 11px;
      color:#374151;
      display:block;
      margin-top: 10px;
    }
    .mini-body select{
      width:100%;
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(148,163,184,.55);
      outline:none;
      font-size: 14px;
      min-height: 44px;
      background:#fff;
    }

    .mini-count{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #eef2ff;
      border: 1px solid rgba(99,102,241,.25);
      font-weight: 1000;
      font-size: 13px;
    }

    .mini-actions{
      display:flex;
      gap:10px;
      margin-top: 12px;
    }
    .mini-actions .btn-apply,
    .mini-actions .btn-reset{
      flex:1;
      min-height: 44px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 900;
      cursor:pointer;
      border:none;
    }
    .mini-actions .btn-apply{ background: var(--brandBlue); color:#fff; }
    .mini-actions .btn-reset{
      background:#f3f4f6;
      color:#111827;
      border:1px solid #d1d5db;
    }

    /* Leaflet */
    .leaflet-control-zoom a{
      width:44px !important;
      height:44px !important;
      line-height:44px !important;
      font-size:18px !important;
    }
    .leaflet-container{ touch-action: pan-x pan-y; }

    /* ‚úÖ Zoom en bas √† gauche : marge safe-area */
    .leaflet-bottom.leaflet-left{
      margin-left: 8px;
      margin-bottom: calc(12px + var(--safeBottom));
    }

    .leaflet-popup-content-wrapper{ border-radius: 14px !important; overflow:hidden; }
    .leaflet-popup-content{ margin: 10px 12px !important; font-size: 14px !important; line-height: 1.35 !important; }
    .leaflet-popup-close-button{ width:34px !important; height:34px !important; font-size:22px !important; }

    /* ============================
       ‚úÖ Bouton üîî Suivi station
       ============================ */
    .follow-btn{
      width:100%;
      border:0;
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      background:#0f2b7a;
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin-top:10px;
      user-select:none;
    }
    .follow-btn.is-followed{
      background:#0b1220;
      border:1px solid #e5e7eb;
      color:#111;
    }
    .follow-btn:disabled{opacity:.6;cursor:not-allowed;}
    .follow-note{
      margin-top:6px;
      font-size:12px;
      color:#475569;
      line-height:1.2;
    }
  </style>
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="logo">M</div>
        <div class="brand-title">
          <strong>Disponibilit√© du carburant</strong>
          <span>Bamako & R√©gions ¬∑ Malitadji</span>
        </div>
      </div>

      <div class="top-actions">
        <button class="icon-btn" id="locBtn" title="Ma position" aria-label="Ma position">‚åñ</button>
        <a class="icon-btn" href="{% url 'home' %}" title="Accueil" aria-label="Accueil">‚åÇ</a>
      </div>
    </header>

    <div class="map-wrap">
      <div id="map"></div>

      <!-- L√©gende -->
      <div class="legend" id="legendBox">
        <div class="head">
          <span>L√©gende</span>
          <button class="toggle" id="legendToggle" type="button" aria-label="R√©duire la l√©gende">‚ñæ</button>
        </div>
        <div class="rows">
          <div class="row"><span class="dot ok"></span>Disponible</div>
          <div class="row"><span class="dot warn"></span>Faible</div>
          <div class="row"><span class="dot bad"></span>Rupture</div>
          <div class="row"><span class="dot unk"></span>Inconnu</div>
        </div>
      </div>

      <!-- Boutons discrets -->
      <div class="mini-fab">
        <button class="mini-btn" id="recenterBtn" type="button" aria-label="Recentrer">‚óé</button>
        <button class="mini-btn primary" id="toggleFiltersBtn" type="button" aria-label="Filtres">Filtres</button>
      </div>

      <!-- Panneau discret coin -->
      <div class="mini-panel" id="miniFilters">
        <div class="mini-head">
          <div class="mini-title">Filtres</div>
          <button class="mini-close" id="closeMiniBtn" type="button" aria-label="Fermer">‚úï</button>
        </div>

        <div class="mini-body">
          <form method="get" id="filtersForm">
            <label>R√©gion</label>
            <select name="region" id="id_region" data-selected="{{ region_selected }}">
              <option value="" {% if not region_selected %}selected{% endif %}>Toutes</option>
              {% for r in regions %}
              <option value="{{ r.id }}" {% if r.id|stringformat:"s" == region_selected %}selected{% endif %}>{{ r.nom }}</option>
              {% endfor %}
            </select>

            <label>Cercle</label>
            <select name="cercle" id="id_cercle" data-selected="{{ cercle_selected }}">
              <option value="" {% if not cercle_selected %}selected{% endif %}>Tous</option>
              {% for ce in cercles %}
              <option value="{{ ce.id }}" {% if ce.id|stringformat:"s" == cercle_selected %}selected{% endif %}>{{ ce.nom }}</option>
              {% endfor %}
            </select>

            <label>Commune</label>
            <select name="commune" id="id_commune" data-selected="{{ commune_selected }}">
              <option value="" {% if not commune_selected %}selected{% endif %}>Toutes</option>
              {% for c in communes %}
              <option value="{{ c.id }}" {% if c.id|stringformat:"s" == commune_selected %}selected{% endif %}>{{ c.nom }}</option>
              {% endfor %}
            </select>

            <label>Statut</label>
            <select name="statut" id="id_statut">
              <option value="" {% if not statut_selected %}selected{% endif %}>Tous</option>
              <option value="dispo" {% if statut_selected == "dispo" %}selected{% endif %}>Disponible</option>
              <option value="faible" {% if statut_selected == "faible" %}selected{% endif %}>Faible</option>
              <option value="rupture" {% if statut_selected == "rupture" %}selected{% endif %}>Rupture</option>
            </select>

            <div class="mini-count">
              Stations : <span id="stationCount">0</span>
            </div>

            <div class="mini-actions">
              <button type="submit" class="btn-apply">Appliquer</button>
              <button type="button" id="resetBtn" class="btn-reset">R√©initialiser</button>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ----------------------------
    // Utils
    // ----------------------------
    function normalize(s){ return (s || "").toString().trim().toLowerCase(); }

    function formatDateFR(value){
      if(!value) return "-";
      const d = new Date(value);
      if (isNaN(d.getTime())) return value;
      const pad = (n) => String(n).padStart(2, "0");
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function getColor(essence, gasoil) {
      const e = normalize(essence);
      const g = normalize(gasoil);
      if (e === 'rupture' || g === 'rupture') return 'red';
      if (e === 'faible'  || g === 'faible')  return 'orange';
      if (e === 'dispo'   || g === 'dispo')   return 'green';
      return 'gray';
    }

    // ‚úÖ CSRF (pour POST Django)
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function updateFollowBtn(btn, followed){
      btn.dataset.followed = followed ? "1" : "0";
      btn.classList.toggle("is-followed", followed);
      btn.textContent = followed ? "üîï Ne plus suivre" : "üîî Suivre cette station";
    }

    // ‚úÖ click handler global (popup dynamique)
    document.addEventListener("click", async function(e){
      const btn = e.target.closest(".follow-btn");
      if(!btn) return;

      const stationId = btn.dataset.stationId;
      const produit = btn.dataset.produit || ""; // "" = tous produits
      btn.disabled = true;

      try{
        const form = new FormData();
        form.append("produit", produit);

        const res = await fetch(`/stations/${stationId}/toggle-follow/`, {
          method: "POST",
          headers: { "X-CSRFToken": csrftoken },
          body: form
        });

        const ct = res.headers.get("content-type") || "";
        if(!ct.includes("application/json")){
          alert("Veuillez vous connecter pour suivre une station.");
          window.location.href = "/accounts/login/?next=" + encodeURIComponent(window.location.pathname);
          return;
        }

        const data = await res.json();
        if(!data.ok){
          alert(data.error || "Erreur lors du suivi");
          return;
        }

        updateFollowBtn(btn, data.followed);
      }catch(err){
        console.error(err);
        alert("Erreur r√©seau");
      }finally{
        btn.disabled = false;
      }
    });

    // ----------------------------
    // Map init
    // ----------------------------
    var map = L.map('map', { zoomControl: false }).setView([12.65, -8.0], 6);
    L.control.zoom({ position: 'bottomleft' }).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    var markers = [];
    var boundsAll = [];

    function clearMarkers(){
      markers.forEach(m => {
        try{ map.removeLayer(m); }catch(e){}
      });
      markers = [];
      boundsAll = [];
    }

    // ----------------------------
    // Filters UI open/close
    // ----------------------------
    const mini = document.getElementById('miniFilters');
    const toggleBtn = document.getElementById('toggleFiltersBtn');
    const closeMiniBtn = document.getElementById('closeMiniBtn');

    function openMini(){ mini.classList.add('open'); try{ map.closePopup(); }catch(e){} }
    function closeMini(){ mini.classList.remove('open'); }

    toggleBtn.addEventListener('click', () => {
      mini.classList.contains('open') ? closeMini() : openMini();
    });
    closeMiniBtn.addEventListener('click', closeMini);
    map.on('click', () => closeMini());

    // ----------------------------
    // Legend toggle
    // ----------------------------
    const legendBox = document.getElementById('legendBox');
    document.getElementById('legendToggle').addEventListener('click', () => {
      legendBox.classList.toggle('collapsed');
      document.getElementById('legendToggle').textContent = legendBox.classList.contains('collapsed') ? '‚ñ∏' : '‚ñæ';
    });

    // ----------------------------
    // Geoloc
    // ----------------------------
    document.getElementById('locBtn').addEventListener('click', () => {
      if(!navigator.geolocation){ alert("G√©olocalisation non disponible."); return; }
      navigator.geolocation.getCurrentPosition((pos) => {
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 14, { animate: true });
        L.circleMarker([latitude, longitude], { radius: 8 }).addTo(map)
          .bindPopup("Vous √™tes ici").openPopup();
      }, () => alert("Impossible d‚Äôobtenir la position."));
    });

    // ----------------------------
    // Data for dropdown dependencies (from Django context)
    // ----------------------------
    const cerclesData = JSON.parse('{{ cercles_json|escapejs }}');   // [{id, nom, region_id}, ...]
    const communesData = JSON.parse('{{ communes_json|escapejs }}'); // [{id, nom, cercle_id}, ...]

    const regionSelect  = document.getElementById('id_region');
    const cercleSelect  = document.getElementById('id_cercle');
    const communeSelect = document.getElementById('id_commune');
    const statutSelect  = document.getElementById('id_statut');
    const stationCountEl = document.getElementById('stationCount');

    const selectedRegion  = regionSelect.dataset.selected || "";
    const selectedCercle  = cercleSelect.dataset.selected || "";
    const selectedCommune = communeSelect.dataset.selected || "";

    function populateCercles(regionId, keepSelectedValue) {
      const keep = keepSelectedValue ? (cercleSelect.value || selectedCercle) : "";
      cercleSelect.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "Tous";
      cercleSelect.appendChild(optAll);

      cerclesData.forEach(function(ce) {
        if (regionId && String(ce.region_id) !== String(regionId)) return;
        const opt = document.createElement("option");
        opt.value = ce.id;
        opt.textContent = ce.nom;
        if (keep && String(ce.id) === String(keep)) opt.selected = true;
        cercleSelect.appendChild(opt);
      });
    }

    function populateCommunes(regionId, cercleId, keepSelectedValue) {
      const keep = keepSelectedValue ? (communeSelect.value || selectedCommune) : "";
      communeSelect.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "Toutes";
      communeSelect.appendChild(optAll);

      communesData.forEach(function(c) {
        // si cercle choisi: filtre strict
        if (cercleId && String(c.cercle_id) !== String(cercleId)) return;

        // si pas cercle mais region: filtre via cercle.region_id
        if (!cercleId && regionId) {
          const cercle = cerclesData.find(ce => String(ce.id) === String(c.cercle_id));
          if (!cercle || String(cercle.region_id) !== String(regionId)) return;
        }

        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.nom;
        if (keep && String(c.id) === String(keep)) opt.selected = true;
        communeSelect.appendChild(opt);
      });
    }

    // ----------------------------
    // Fetch GeoJSON + build markers
    // ----------------------------
    function buildGeoUrl(){
      const params = new URLSearchParams();
      const regionId = regionSelect.value || "";
      const cercleId = cercleSelect.value || "";
      const communeId = communeSelect.value || "";
      const statutVal = statutSelect.value || "";

      if(regionId) params.set("region", regionId);
      if(cercleId) params.set("cercle", cercleId);
      if(communeId) params.set("commune", communeId);
      if(statutVal) params.set("statut", statutVal);

      const q = params.toString();
      return "/api/stations.geojson" + (q ? ("?" + q) : "");
    }

    async function reloadStationsFromApi({fitBounds = true} = {}){
      clearMarkers();

      const url = buildGeoUrl();
      const res = await fetch(url);
      const geo = await res.json();

      (geo.features || []).forEach((f) => {
        const p = f.properties || {};
        const coords = (f.geometry && f.geometry.coordinates) || null;
        if(!coords || coords.length < 2) return;

        const lng = Number(coords[0]);
        const lat = Number(coords[1]);
        if(!lat || !lng) return;

        const color = getColor(p.essence, p.gasoil);

        const marker = L.circleMarker([lat, lng], {
          radius: 8,
          color: color,
          fillColor: color,
          fillOpacity: 0.9
        }).addTo(map);

        marker.__station = {
          id: p.id,
          nom: p.nom,
          adresse: p.adresse,
          region: p.region,
          cercle: p.cercle,
          commune: p.commune,

          region_id: p.region_id,
          cercle_id: p.cercle_id,
          commune_id: p.commune_id,

          essence_statut: p.essence,
          gasoil_statut: p.gasoil,
          last_update: p.derniere_maj,
          is_followed: !!p.is_followed,
        };

        const s = marker.__station;
        const lastUpdateText = formatDateFR(s.last_update);
        const followed = !!s.is_followed;

        marker.bindPopup(`
          <div style="font-weight:900;font-size:15px;margin-bottom:6px">${s.nom}</div>
          <div style="color:#334155;font-size:13px">
            <div><b>R√©gion:</b> ${s.region || "-"}</div>
            <div><b>Cercle:</b> ${s.cercle || "-"}</div>
            <div><b>Commune:</b> ${s.commune || "-"}</div>

            <div style="margin-top:8px"><b>Essence:</b> ${s.essence_statut || "-"}</div>
            <div><b>Gasoil:</b> ${s.gasoil_statut || "-"}</div>

            <div style="margin-top:8px"><b>Mise √† jour:</b> ${lastUpdateText}</div>

            <button
              type="button"
              class="follow-btn ${followed ? "is-followed" : ""}"
              data-station-id="${s.id}"
              data-produit=""
              data-followed="${followed ? "1" : "0"}"
            >${followed ? "üîï Ne plus suivre" : "üîî Suivre cette station"}</button>

            <div class="follow-note">Notification uniquement quand le stock devient <b>PLEIN</b>.</div>

            <div style="margin-top:10px">
              <a href="/manager/" style="display:inline-block;padding:10px 12px;border-radius:12px;background:#1e3a8a;color:#fff;font-weight:900;text-decoration:none">
                üîê Espace g√©rant
              </a>
            </div>
          </div>
        `, { maxWidth: 280 });

        markers.push(marker);
        boundsAll.push([lat, lng]);
      });

      stationCountEl.textContent = String(markers.length);

      if(fitBounds && boundsAll.length > 0){
        map.fitBounds(boundsAll, { padding:[40,40] });
      }
      setTimeout(() => map.invalidateSize(), 250);
    }

    // ----------------------------
    // Sync inverse + d√©pendances dropdown
    // ----------------------------
    regionSelect.addEventListener('change', function() {
      const regionId = this.value || "";
      populateCercles(regionId, false);
      populateCommunes(regionId, cercleSelect.value || "", false);
    });

    cercleSelect.addEventListener('change', function() {
      const cercleId = this.value || "";
      if(!cercleId){
        populateCommunes(regionSelect.value || "", "", false);
        return;
      }
      // cercle -> region auto
      const cercle = cerclesData.find(ce => String(ce.id) === String(cercleId));
      if(cercle && String(regionSelect.value || "") !== String(cercle.region_id)){
        regionSelect.value = String(cercle.region_id);
        populateCercles(regionSelect.value, true);
      }
      populateCommunes(regionSelect.value || "", cercleId, false);
    });

    communeSelect.addEventListener('change', function() {
      const communeId = this.value || "";
      if(!communeId) return;

      const commune = communesData.find(c => String(c.id) === String(communeId));
      if(!commune) return;

      // commune -> cercle
      const cercleId = String(commune.cercle_id);
      if(String(cercleSelect.value || "") !== cercleId){
        cercleSelect.value = cercleId;
      }

      // cercle -> region
      const cercle = cerclesData.find(ce => String(ce.id) === cercleId);
      if(cercle && String(regionSelect.value || "") !== String(cercle.region_id)){
        regionSelect.value = String(cercle.region_id);
        populateCercles(regionSelect.value, true);
      }

      // recharge communes du cercle (et garde la commune)
      populateCommunes(regionSelect.value || "", cercleId, true);
    });

    // ----------------------------
    // Apply / Reset / Recenter
    // ----------------------------
    document.getElementById('filtersForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      closeMini();
      await reloadStationsFromApi({fitBounds: true});
    });

    document.getElementById('resetBtn').addEventListener('click', async () => {
      regionSelect.value = "";
      cercleSelect.value = "";
      communeSelect.value = "";
      statutSelect.value = "";

      populateCercles("", false);
      populateCommunes("", "", false);

      await reloadStationsFromApi({fitBounds: true});
    });

    document.getElementById('recenterBtn').addEventListener('click', () => {
      if(boundsAll.length === 0){
        alert("Aucune station √† afficher.");
        return;
      }
      map.fitBounds(boundsAll, { padding: [50, 50] });
      closeMini();
    });

    // ----------------------------
    // Initial load
    // ----------------------------
    document.addEventListener('DOMContentLoaded', async function() {
      // initialiser dropdowns selon s√©lection serveur
      if(selectedRegion) regionSelect.value = selectedRegion;
      populateCercles(selectedRegion, true);
      if(selectedCercle) cercleSelect.value = selectedCercle;
      populateCommunes(selectedRegion, selectedCercle, true);
      if(selectedCommune) communeSelect.value = selectedCommune;

      // charge stations initiales via API avec les valeurs actuelles
      await reloadStationsFromApi({fitBounds: true});
    });
  </script>
</body>
</html>
