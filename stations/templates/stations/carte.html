<!-- stations/templates/stations/carte.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Malitadji ‚Äì Carte carburant Mali</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#020617" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#020617;
      --panel:#0b1220;
      --line: rgba(148,163,184,.28);
      --text:#e5e7eb;
      --muted:#9ca3af;

      --card:#ffffff;
      --cardText:#111827;

      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);
      --safeLeft: env(safe-area-inset-left);
      --safeRight: env(safe-area-inset-right);

      /* ‚úÖ Topbar compact mobile */
      --topbarH: 52px;

      --brandGreen1:#22c55e;
      --brandGreen2:#16a34a;
      --brandGreen3:#15803d;
      --brandBlue:#1e3a8a;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow:hidden;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }
    a{color:inherit;text-decoration:none}

    .app{
      position:fixed;
      inset:0;
      display:flex;
      flex-direction:column;
      padding-left: var(--safeLeft);
      padding-right: var(--safeRight);
    }

    /* ===== Topbar (compact mobile menu in black band) ===== */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 4000;
      height: calc(var(--topbarH) + var(--safeTop));
      padding: calc(8px + var(--safeTop)) 10px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(to right, rgba(2,6,23,.98), rgba(2,6,23,.85));
      border-bottom: 1px solid rgba(15,23,42,.95);
      backdrop-filter: blur(10px);
    }

    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{
      width:30px;height:30px;border-radius:12px;
      background: radial-gradient(circle at 30% 20%, var(--brandGreen1), var(--brandGreen2), var(--brandGreen3));
      display:grid;place-items:center;
      color:#022c22;font-weight:900;flex:0 0 auto;
    }
    .brand-title{min-width:0;display:flex;flex-direction:column;gap:1px}
    .brand-title strong{
      font-size:13px;font-weight:900;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .brand-title span{
      font-size:11px;color:var(--muted);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    /* ‚úÖ Compact icon actions */
    .top-actions{display:flex;gap:8px;flex:0 0 auto;align-items:center}
    .icon-btn{
      width:38px;height:38px;border-radius:12px;
      border:1px solid rgba(148,163,184,.28);
      background: rgba(15,23,42,.55);
      color: var(--text);
      display:grid;place-items:center;
      cursor:pointer;
      user-select:none;
      padding:0;
    }
    .icon-btn:active{ transform: translateY(1px); }
    .icon-btn svg{ width:18px;height:18px; }

    /* Desktop: un peu plus grand */
    @media (min-width: 900px){
      .icon-btn{ width:44px;height:44px;border-radius:14px; }
      .icon-btn svg{ width:20px;height:20px; }
      :root{ --topbarH: 64px; }
      .brand-title strong{ font-size:14px; }
    }

    /* ===== Map ===== */
    .map-wrap{
      position:relative;
      flex:1;
      min-height:0;
    }
    #map{
      position:absolute;
      inset:0;
      height:100%;
      width:100%;
      background: var(--panel);
      z-index: 1;
    }

    /* ===== Legend (compact + collapsible) ===== */
    .legend{
      position:absolute;
      z-index: 2500;
      left: 12px;
      bottom: calc(12px + var(--safeBottom));
      background: rgba(255,255,255,.96);
      color: #111827;
      border-radius: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,.22);
      border: 1px solid rgba(148,163,184,.35);
      padding: 10px 12px;
      font-size: 13px;
      max-width: 220px;
      user-select:none;
    }
    .legend .head{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;font-weight:900;margin-bottom:6px;
    }
    .legend .toggle{
      width:30px;height:30px;border-radius:10px;
      border:1px solid rgba(148,163,184,.45);
      background:#fff;
      display:grid;place-items:center;
      cursor:pointer;font-weight:900;
    }
    .legend .rows{display:block}
    .legend.collapsed .rows{display:none}
    .legend .row{display:flex;align-items:center;gap:8px;margin:5px 0}
    .legend .dot{width:12px;height:12px;border-radius:999px;display:inline-block}
    .dot.ok{background:green}
    .dot.warn{background:orange}
    .dot.bad{background:red}
    .dot.unk{background:gray}

    /* Leaflet */
    .leaflet-control-zoom a{
      width:44px !important;
      height:44px !important;
      line-height:44px !important;
      font-size:18px !important;
    }
    .leaflet-container{ touch-action: pan-x pan-y; }

    .leaflet-bottom.leaflet-left{
      margin-left: 8px;
      margin-bottom: calc(12px + var(--safeBottom));
    }

    .leaflet-popup-content-wrapper{ border-radius: 14px !important; overflow:hidden; }
    .leaflet-popup-content{ margin: 10px 12px !important; font-size: 14px !important; line-height: 1.35 !important; }
    .leaflet-popup-close-button{ width:34px !important; height:34px !important; font-size:22px !important; }

    /* ============================
       ‚úÖ Bouton üîî Suivi station
       ============================ */
    .follow-btn{
      width:100%;
      border:0;
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      background:#0f2b7a;
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin-top:10px;
      user-select:none;
    }
    .follow-btn.is-followed{
      background:#0b1220;
      border:1px solid #e5e7eb;
      color:#111;
    }
    .follow-note{
      margin-top:6px;
      font-size:12px;
      color:#475569;
      line-height:1.2;
    }

    /* ============================
       ‚úÖ Bouton centrer carte (sous la topbar)
       ============================ */
    .center-map-btn{
      position:absolute;
      right: 12px;
      top: calc(var(--topbarH) + var(--safeTop) + 10px);
      z-index: 4250;

      width: 52px;
      height: 52px;
      border-radius: 18px;

      border: 1px solid rgba(148,163,184,.35);
      background: rgba(255,255,255,.94);
      color:#0f172a;

      font-weight: 1000;
      font-size: 20px;
      cursor:pointer;
      box-shadow: 0 14px 30px rgba(0,0,0,.22);
      user-select:none;
    }
    .center-map-btn:active{ transform: translateY(1px); }

    /* ============================
       ‚úÖ Mini panels (Filtres / Suivies / Recherche)
       ============================ */
.mini-panel{
  position:absolute;
  left: 12px;
  right: 12px;

  /* üîë cl√© du fix */
  top: calc(var(--topbarH) + var(--safeTop) + 12px);
  bottom: calc(12px + var(--safeBottom));

  z-index: 4400;
  background: rgba(255,255,255,.98);
  color:#111827;
  border-radius: 16px;
  box-shadow: 0 18px 40px rgba(0,0,0,.30);
  border: 1px solid rgba(148,163,184,.35);

  overflow: hidden;
  display:none;
}
.mini-panel.open{ display:block; }

.mini-body{
  padding: 10px 12px 12px;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  height: calc(100% - 56px); /* header du panneau */
}

    .mini-panel.open{ display:block; }

    .mini-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      background:#fff;
      border-bottom: 1px solid rgba(148,163,184,.28);
    }
    .mini-title{ font-weight:1000; font-size: 13px; }

    .mini-close{
      width:38px;height:38px;border-radius:14px;
      border:1px solid rgba(148,163,184,.45);
      background:#fff;
      display:grid;place-items:center;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }

    .mini-body{
      padding: 10px 12px 12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .mini-body label{
      font-weight: 900;
      font-size: 11px;
      color:#374151;
      display:block;
      margin-top: 10px;
    }
    .mini-body select{
      width:100%;
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(148,163,184,.55);
      outline:none;
      font-size: 14px;
      min-height: 44px;
      background:#fff;
    }

    .mini-count{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #eef2ff;
      border: 1px solid rgba(99,102,241,.25);
      font-weight: 1000;
      font-size: 13px;
    }

    .mini-actions{
      display:flex;
      gap:10px;
      margin-top: 12px;
    }
    .mini-actions .btn-apply,
    .mini-actions .btn-reset{
      flex:1;
      min-height: 44px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 900;
      cursor:pointer;
      border:none;
      user-select:none;
    }
    .mini-actions .btn-apply{ background: var(--brandBlue); color:#fff; }
    .mini-actions .btn-reset{
      background:#f3f4f6;
      color:#111827;
      border:1px solid #d1d5db;
    }

    /* ===== Panneau Suivies ===== */
    .followed-wrap{ padding: 12px; }
    .followed-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom: 8px;
    }
    .followed-title{ font-weight:1000; font-size:13px; color:#0f172a; }
    .followed-actions{ display:flex; gap:8px; align-items:center; }
    .mini-linkbtn{
      border:1px solid rgba(148,163,184,.45);
      background:#fff;
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .mini-linkbtn.danger{
      border-color: rgba(239,68,68,.35);
      color:#b91c1c;
      background: rgba(254,242,242,.85);
    }
    .followed-list{ display:flex; flex-direction:column; gap:8px; }
    .followed-item{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(148,163,184,.35);
      background: rgba(241,245,249,.55);
    }
    .followed-item .meta{ min-width:0; display:flex; flex-direction:column; gap:3px; }
    .followed-item .name{
      font-weight:1000; font-size:13px; color:#0f172a;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 220px;
    }
    .followed-item .sub{
      font-size:12px; color:#475569;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 220px;
    }
    .followed-item .go{
      border:0;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 1000;
      cursor:pointer;
      background: var(--brandBlue);
      color:#fff;
      flex:0 0 auto;
      user-select:none;
    }
    .followed-empty{
      font-size: 13px;
      color:#475569;
      background: rgba(241,245,249,.6);
      border:1px dashed rgba(148,163,184,.6);
      border-radius: 12px;
      padding: 10px 12px;
    }

    /* ‚úÖ Petit badge compteur stations (optionnel) */
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,.28);
      background: rgba(15,23,42,.40);
      color: var(--text);
      font-weight: 900;
      font-size: 12px;
      user-select:none;
    }
    @media (max-width: 520px){
      .brand-title span{ display:none; }
      .pill{ display:none; }
    }

    /* ============================
       ‚úÖ Recherche - styles r√©sultats
       ============================ */
    .search-item{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(148,163,184,.35);
      background: rgba(241,245,249,.55);
    }
    .search-item .meta{ min-width:0; display:flex; flex-direction:column; gap:3px; }
    .search-item .name{
      font-weight:1000; font-size:13px; color:#0f172a;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 240px;
    }
    .search-item .sub{
      font-size:12px; color:#475569;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 240px;
    }
    .search-item .go{
      border:0;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 1000;
      cursor:pointer;
      background: var(--brandBlue);
      color:#fff;
      flex:0 0 auto;
      user-select:none;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- ‚úÖ MENU COMPACT MOBILE DANS LA BANDE NOIRE -->
    <header class="topbar">
      <div class="brand">
        <div class="logo">M</div>
        <div class="brand-title">
          <strong>Carburant Mali</strong>
          <span>Bamako & R√©gions ¬∑ Malitadji</span>
        </div>
        <div class="pill" title="Stations charg√©es">
          <span id="stationCountTop">0</span> stations
        </div>
      </div>

      <div class="top-actions">
        <!-- Recherche -->
        <button class="icon-btn" id="searchBtn" title="Recherche" aria-label="Recherche">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm11 3-6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>

        <!-- Suivies -->
        <button class="icon-btn" id="followedBtn" title="Stations suivies" aria-label="Suivies">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 17.3 6.2 20.5l1.1-6.5L2.6 9.9l6.6-1L12 3l2.8 5.9 6.6 1-4.7 4.1 1.1 6.5z"
              fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
        </button>

        <!-- Filtres -->
        <button class="icon-btn" id="filtersBtn" title="Filtres" aria-label="Filtres">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 21v-7m0-4V3m8 18v-9m0-4V3m8 18v-5m0-4V3M2 14h4m4-2h4m4 4h4"
              fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>

        <!-- Reset -->
        <button class="icon-btn" id="resetTopBtn" title="R√©initialiser" aria-label="Reset">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M21 12a9 9 0 1 1-3-6.7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M21 3v6h-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <!-- Ma position -->
        <button class="icon-btn" id="locBtn" title="Ma position" aria-label="Ma position">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm9 4h-2.1A7 7 0 0 0 12 5.1V3h0v2.1A7 7 0 0 0 5.1 12H3v0h2.1A7 7 0 0 0 12 18.9V21h0v-2.1A7 7 0 0 0 18.9 12H21Z"
              fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <!-- Accueil -->
        <a class="icon-btn" href="{% url 'home' %}" title="Accueil" aria-label="Accueil">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1Z"
              fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
        </a>
      </div>
    </header>

    <div class="map-wrap">
      <div id="map"></div>

      <!-- ‚úÖ Bouton centrer la carte -->
      <button class="center-map-btn" id="centerMapBtn" type="button" title="Centrer la carte" aria-label="Centrer la carte">‚äï</button>

      <!-- L√©gende -->
      <div class="legend" id="legendBox">
        <div class="head">
          <span>L√©gende</span>
          <button class="toggle" id="legendToggle" type="button" aria-label="R√©duire la l√©gende">‚ñæ</button>
        </div>
        <div class="rows">
          <div class="row"><span class="dot ok"></span>Disponible</div>
          <div class="row"><span class="dot warn"></span>Faible / Bas</div>
          <div class="row"><span class="dot bad"></span>Rupture</div>
          <div class="row"><span class="dot unk"></span>Inconnu</div>
        </div>
      </div>

      <!-- Panneau (Filtres) -->
      <div class="mini-panel" id="miniFilters">
        <div class="mini-head">
          <div class="mini-title">Filtres</div>
          <button class="mini-close" id="closeMiniBtn" type="button" aria-label="Fermer">‚úï</button>
        </div>

        <div class="mini-body">
          <form method="get" id="filtersForm">
            <label>R√©gion</label>
            <select name="region" id="id_region" data-selected="{{ region_selected }}">
              <option value="" {% if not region_selected %}selected{% endif %}>Toutes</option>
              {% for r in regions %}
              <option value="{{ r.id }}" {% if r.id|stringformat:"s" == region_selected %}selected{% endif %}>{{ r.nom }}</option>
              {% endfor %}
            </select>

            <label>Cercle</label>
            <select name="cercle" id="id_cercle" data-selected="{{ cercle_selected }}">
              <option value="" {% if not cercle_selected %}selected{% endif %}>Tous</option>
              {% for ce in cercles %}
              <option value="{{ ce.id }}" {% if ce.id|stringformat:"s" == cercle_selected %}selected{% endif %}>{{ ce.nom }}</option>
              {% endfor %}
            </select>

            <label>Commune</label>
            <select name="commune" id="id_commune" data-selected="{{ commune_selected }}">
              <option value="" {% if not commune_selected %}selected{% endif %}>Toutes</option>
              {% for c in communes %}
              <option value="{{ c.id }}" {% if c.id|stringformat:"s" == commune_selected %}selected{% endif %}>{{ c.nom }}</option>
              {% endfor %}
            </select>

            <label>Statut</label>
            <select name="statut" id="id_statut">
              <option value="" {% if not statut_selected %}selected{% endif %}>Tous</option>
              <option value="dispo"   {% if statut_selected == "dispo" %}selected{% endif %}>Disponible</option>
              <option value="faible"  {% if statut_selected == "faible" %}selected{% endif %}>Faible (Bas + Faible)</option>
              <option value="rupture" {% if statut_selected == "rupture" %}selected{% endif %}>Rupture</option>
              <option value="inconnu" {% if statut_selected == "inconnu" %}selected{% endif %}>Inconnu</option>
            </select>

            <div class="mini-count">
              Stations : <span id="stationCount">0</span>
            </div>

            <div class="mini-actions">
              <button type="button" id="openFollowedFromFilters" class="btn-reset">‚òÖ Suivies</button>
              <button type="submit" class="btn-apply">‚úî Appliquer</button>
              <button type="button" id="resetBtn" class="btn-reset">‚Ü∫ R√©initialiser</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Panneau Suivies -->
      <div class="mini-panel" id="miniFollowed">
        <div class="mini-head">
          <div class="mini-title">Mes stations suivies</div>
          <button class="mini-close" id="closeFollowedBtn" type="button" aria-label="Fermer">‚úï</button>
        </div>
        <div class="followed-wrap">
          <div class="followed-head">
            <div class="followed-title">Sur ce navigateur</div>
            <div class="followed-actions">
              <button type="button" class="mini-linkbtn" id="refreshFollowedBtn">Rafra√Æchir</button>
              <button type="button" class="mini-linkbtn danger" id="clearFollowedBtn" title="Supprimer toutes les stations suivies">Tout effacer</button>
            </div>
          </div>
          <div id="followedList" class="followed-list"></div>
          <div style="margin-top:10px;font-size:12px;color:#475569;line-height:1.25">
            Astuce: ouvre une station puis clique <b>Suivre cette station</b>.
          </div>
        </div>
      </div>

      <!-- ‚úÖ Panneau Recherche (nouveau) -->
      <div class="mini-panel" id="miniSearch">
        <div class="mini-head">
          <div class="mini-title">Recherche</div>
          <button class="mini-close" id="closeSearchBtn" type="button" aria-label="Fermer">‚úï</button>
        </div>

        <div class="mini-body">
          <label>Nom de station</label>
          <input id="searchInput" type="search" placeholder="Ex: Total, Shell, Station 15..."
            style="width:100%;margin-top:6px;padding:10px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.55);outline:none;font-size:14px;min-height:44px;background:#fff" />

          <div style="display:flex;gap:10px;margin-top:10px;">
            <button type="button" id="searchClearBtn"
              style="flex:1;min-height:44px;border-radius:14px;font-size:13px;font-weight:900;cursor:pointer;border:1px solid #d1d5db;background:#f3f4f6;">
              Effacer
            </button>
            <button type="button" id="searchGoBtn"
              style="flex:1;min-height:44px;border-radius:14px;font-size:13px;font-weight:900;cursor:pointer;border:none;background:var(--brandBlue);color:#fff;">
              Rechercher
            </button>
          </div>

          <div class="mini-count" style="margin-top:12px;background:#f8fafc;border:1px solid rgba(148,163,184,.35)">
            R√©sultats : <span id="searchCount">0</span>
          </div>

          <div id="searchResults" style="margin-top:10px;display:flex;flex-direction:column;gap:8px;"></div>

          <div style="margin-top:10px;font-size:12px;color:#475569;line-height:1.25">
            Astuce: tape 2‚Äì3 lettres, puis clique sur une station.
          </div>
        </div>
      </div>

    </div><!-- /map-wrap -->
  </div><!-- /app -->

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Utils
    function normalize(s){ return (s || "").toString().trim().toLowerCase(); }
    function formatDateFR(value){
      if(!value) return "-";
      const d = new Date(value);
      if (isNaN(d.getTime())) return value;
      const pad = (n) => String(n).padStart(2, "0");
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    // ‚úÖ API renvoie: dispo / faible / rupture / inconnu
    function getColor(essence, gasoil) {
      const e = normalize(essence);
      const g = normalize(gasoil);
      if (e === 'rupture' || g === 'rupture') return 'red';
      if (e === 'faible'  || g === 'faible')  return 'orange';
      if (e === 'dispo'   || g === 'dispo')   return 'green';
      return 'gray';
    }

    function getGlobalStatus(essence, gasoil){
      const e = normalize(essence);
      const g = normalize(gasoil);
      if (e === "rupture" || g === "rupture") return "rupture";
      if (e === "faible"  || g === "faible")  return "faible";
      if (e === "dispo"   || g === "dispo")   return "dispo";
      return "inconnu";
    }

    // ‚úÖ Suivi local (Web)
    const LS_FOLLOWS_KEY = "malitadji_followed_stations_v1";
    function getFollowedLocal(){
      try{
        const raw = localStorage.getItem(LS_FOLLOWS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function isFollowedLocal(stationId){ return getFollowedLocal().includes(String(stationId)); }
    function toggleFollowLocal(stationId){
      const id = String(stationId);
      const list = new Set(getFollowedLocal());
      if(list.has(id)) list.delete(id); else list.add(id);
      localStorage.setItem(LS_FOLLOWS_KEY, JSON.stringify([...list]));
      return list.has(id);
    }
    function clearFollowedLocal(){ localStorage.setItem(LS_FOLLOWS_KEY, JSON.stringify([])); }
    function updateFollowBtn(btn, followed){
      btn.dataset.followed = followed ? "1" : "0";
      btn.classList.toggle("is-followed", followed);
      btn.textContent = followed ? "üîï Ne plus suivre" : "üîî Suivre cette station";
    }

    // Map init
    var map = L.map('map', { zoomControl: false }).setView([12.65, -8.0], 6);
    L.control.zoom({ position: 'bottomleft' }).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    var markers = [];
    var boundsAll = [];
    var markerById = {}; // stationId -> marker

    function clearMarkers(){
      markers.forEach(m => { try{ map.removeLayer(m); }catch(e){} });
      markers = [];
      boundsAll = [];
      markerById = {};
    }

    // ‚úÖ Panels open/close
    const miniFilters = document.getElementById('miniFilters');
    const miniFollowed = document.getElementById('miniFollowed');
    const miniSearch = document.getElementById('miniSearch');

    const closeMiniBtn = document.getElementById('closeMiniBtn');
    const closeFollowedBtn = document.getElementById('closeFollowedBtn');
    const closeSearchBtn = document.getElementById('closeSearchBtn');

    function openPanel(el){
      miniFilters.classList.remove('open');
      miniFollowed.classList.remove('open');
      miniSearch.classList.remove('open');
      el.classList.add('open');
      try{ map.closePopup(); }catch(e){}
    }

    function closePanels(){
      miniFilters.classList.remove('open');
      miniFollowed.classList.remove('open');
      miniSearch.classList.remove('open');
    }

    closeMiniBtn.addEventListener('click', () => miniFilters.classList.remove('open'));
    closeFollowedBtn.addEventListener('click', () => miniFollowed.classList.remove('open'));
    closeSearchBtn.addEventListener('click', () => miniSearch.classList.remove('open'));
    map.on('click', () => closePanels());

    // Legend toggle
    const legendBox = document.getElementById('legendBox');
    document.getElementById('legendToggle').addEventListener('click', () => {
      legendBox.classList.toggle('collapsed');
      document.getElementById('legendToggle').textContent = legendBox.classList.contains('collapsed') ? '‚ñ∏' : '‚ñæ';
    });

    // Geoloc (topbar)
    document.getElementById('locBtn').addEventListener('click', () => {
      if(!navigator.geolocation){ alert("G√©olocalisation non disponible."); return; }
      navigator.geolocation.getCurrentPosition((pos) => {
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 14, { animate: true });
        L.circleMarker([latitude, longitude], { radius: 8 }).addTo(map)
          .bindPopup("Vous √™tes ici").openPopup();
      }, () => alert("Impossible d‚Äôobtenir la position."));
    });

    // Data for dropdown dependencies (from Django context)
    const cerclesData  = JSON.parse('{{ cercles_json|default:"[]"|escapejs }}');
    const communesData = JSON.parse('{{ communes_json|default:"[]"|escapejs }}');

    const regionSelect  = document.getElementById('id_region');
    const cercleSelect  = document.getElementById('id_cercle');
    const communeSelect = document.getElementById('id_commune');
    const statutSelect  = document.getElementById('id_statut');
    const stationCountEl = document.getElementById('stationCount');
    const stationCountTopEl = document.getElementById('stationCountTop');

    const selectedRegion  = regionSelect.dataset.selected || "";
    const selectedCercle  = cercleSelect.dataset.selected || "";
    const selectedCommune = communeSelect.dataset.selected || "";

    function populateCercles(regionId, keepSelectedValue) {
      const keep = keepSelectedValue ? (cercleSelect.value || selectedCercle) : "";
      cercleSelect.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "Tous";
      cercleSelect.appendChild(optAll);

      cerclesData.forEach(function(ce) {
        if (regionId && String(ce.region_id) !== String(regionId)) return;
        const opt = document.createElement("option");
        opt.value = ce.id;
        opt.textContent = ce.nom;
        if (keep && String(ce.id) === String(keep)) opt.selected = true;
        cercleSelect.appendChild(opt);
      });
    }

    function populateCommunes(regionId, cercleId, keepSelectedValue) {
      const keep = keepSelectedValue ? (communeSelect.value || selectedCommune) : "";
      communeSelect.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "Toutes";
      communeSelect.appendChild(optAll);

      communesData.forEach(function(c) {
        if (cercleId && String(c.cercle_id) !== String(cercleId)) return;

        if (!cercleId && regionId) {
          const cercle = cerclesData.find(ce => String(ce.id) === String(c.cercle_id));
          if (!cercle || String(cercle.region_id) !== String(regionId)) return;
        }

        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.nom;
        if (keep && String(c.id) === String(keep)) opt.selected = true;
        communeSelect.appendChild(opt);
      });
    }

    // Suivies panel rendering
    const followedListEl = document.getElementById("followedList");
    const refreshFollowedBtn = document.getElementById("refreshFollowedBtn");
    const clearFollowedBtn = document.getElementById("clearFollowedBtn");

    function stationSubLine(s){
      const parts = [];
      if(s.commune) parts.push(s.commune);
      if(s.cercle) parts.push(s.cercle);
      if(s.region) parts.push(s.region);
      return parts.join(" ¬∑ ");
    }

    function renderFollowedList(){
      const ids = getFollowedLocal();
      if(!ids.length){
        followedListEl.innerHTML = `<div class="followed-empty">Aucune station suivie pour le moment.</div>`;
        return;
      }

      const rows = [];
      ids.forEach((id) => {
        const m = markerById[String(id)];
        if(!m || !m.__station){
          rows.push(`
            <div class="followed-item">
              <div class="meta">
                <div class="name">Station #${id}</div>
                <div class="sub">Ouvre la carte et recharge pour voir le d√©tail.</div>
              </div>
              <button class="go" type="button" data-go-station="${id}">Voir</button>
            </div>
          `);
          return;
        }
        const s = m.__station;
        rows.push(`
          <div class="followed-item">
            <div class="meta">
              <div class="name">${s.nom}</div>
              <div class="sub">${stationSubLine(s) || "-"}</div>
            </div>
            <button class="go" type="button" data-go-station="${s.id}">Voir</button>
          </div>
        `);
      });

      followedListEl.innerHTML = rows.join("");
    }

    refreshFollowedBtn.addEventListener("click", () => renderFollowedList());
    clearFollowedBtn.addEventListener("click", () => {
      if(!confirm("Supprimer toutes les stations suivies ?")) return;
      clearFollowedLocal();
      renderFollowedList();
      const openPopup = map._popup;
      if(openPopup){
        const btn = openPopup.getElement()?.querySelector?.(".follow-btn");
        if(btn && btn.dataset.stationId){
          updateFollowBtn(btn, false);
        }
      }
    });

    // Delegation pour "Voir" (suivies)
    document.addEventListener("click", (e) => {
      const go = e.target.closest("[data-go-station]");
      if(!go) return;
      const id = String(go.getAttribute("data-go-station"));
      const m = markerById[id];
      if(!m){
        alert("Station non charg√©e. Clique sur Appliquer pour recharger la carte.");
        return;
      }
      miniFollowed.classList.remove("open");
      map.setView(m.getLatLng(), 15, { animate: true });
      m.openPopup();
    });

    // ‚úÖ click handler (popup) ‚Äî toggle localStorage
    document.addEventListener("click", function(e){
      const btn = e.target.closest(".follow-btn");
      if(!btn) return;
      const stationId = btn.dataset.stationId;
      const followed = toggleFollowLocal(stationId);
      updateFollowBtn(btn, followed);
      if(miniFollowed.classList.contains("open")) renderFollowedList();
    });

    // Fetch GeoJSON + build markers
    function buildGeoUrl(){
      const params = new URLSearchParams();
      const regionId = regionSelect.value || "";
      const cercleId = cercleSelect.value || "";
      const communeId = communeSelect.value || "";
      const statutVal = statutSelect.value || "";

      if(regionId) params.set("region", regionId);
      if(cercleId) params.set("cercle", cercleId);
      if(communeId) params.set("commune", communeId);
      if(statutVal) params.set("statut", statutVal);

      const q = params.toString();
      return "/api/stations.geojson/" + (q ? ("?" + q) : "");
    }

    function updateCounts(){
      stationCountEl.textContent = String(markers.length);
      stationCountTopEl.textContent = String(markers.length);
    }

    async function reloadStationsFromApi({fitBounds = true} = {}){
      try{
        stationCountEl.textContent = "‚Ä¶";
        stationCountTopEl.textContent = "‚Ä¶";

        clearMarkers();

        const url = buildGeoUrl();
        const res = await fetch(url);
        if(!res.ok) throw new Error("HTTP " + res.status);
        const geo = await res.json();

        const selectedStatut = statutSelect.value || "";
        const selectedRegionId = regionSelect.value || "";
        const selectedCercleId = cercleSelect.value || "";
        const selectedCommuneId = communeSelect.value || "";

        let features = (geo.features || []);

        // ‚úÖ fallback filtrage c√¥t√© client
        features = features.filter((f) => {
          const p = f.properties || {};

          if (selectedRegionId && String(p.region_id) !== String(selectedRegionId)) return false;
          if (selectedCercleId && String(p.cercle_id) !== String(selectedCercleId)) return false;
          if (selectedCommuneId && String(p.commune_id) !== String(selectedCommuneId)) return false;

          if (selectedStatut){
            const gs = getGlobalStatus(p.essence, p.gasoil);
            if (gs !== selectedStatut) return false;
          }
          return true;
        });

        features.forEach((f) => {
          const p = f.properties || {};
          const coords = (f.geometry && f.geometry.coordinates) || null;
          if(!coords || coords.length < 2) return;

          const lng = Number(coords[0]);
          const lat = Number(coords[1]);
          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

          const color = getColor(p.essence, p.gasoil);

          const marker = L.circleMarker([lat, lng], {
            radius: 8,
            color: color,
            fillColor: color,
            fillOpacity: 0.9
          }).addTo(map);

          marker.__station = {
            id: p.id,
            nom: p.nom,
            adresse: p.adresse,
            region: p.region,
            cercle: p.cercle,
            commune: p.commune,
            region_id: p.region_id,
            cercle_id: p.cercle_id,
            commune_id: p.commune_id,
            essence_statut: p.essence,
            gasoil_statut: p.gasoil,
            last_update: p.derniere_maj,
          };

          const s = marker.__station;
          markerById[String(s.id)] = marker;

          const lastUpdateText = formatDateFR(s.last_update);
          const followed = isFollowedLocal(s.id);

          marker.bindPopup(`
            <div style="font-weight:900;font-size:15px;margin-bottom:6px">${s.nom}</div>
            <div style="color:#334155;font-size:13px">
              <div><b>R√©gion:</b> ${s.region || "-"}</div>
              <div><b>Cercle:</b> ${s.cercle || "-"}</div>
              <div><b>Commune:</b> ${s.commune || "-"}</div>

              <div style="margin-top:8px"><b>Essence:</b> ${s.essence_statut || "-"}</div>
              <div><b>Gasoil:</b> ${s.gasoil_statut || "-"}</div>

              <div style="margin-top:8px"><b>Mise √† jour:</b> ${lastUpdateText}</div>

              <button
                type="button"
                class="follow-btn ${followed ? "is-followed" : ""}"
                data-station-id="${s.id}"
                data-followed="${followed ? "1" : "0"}"
              >${followed ? "üîï Ne plus suivre" : "üîî Suivre cette station"}</button>

              <div class="follow-note">Notifications web: enregistr√©es localement. (Push r√©serv√© √† l'app mobile)</div>

              <div style="margin-top:10px">
                <a href="/manager/" style="display:inline-block;padding:10px 12px;border-radius:12px;background:#1e3a8a;color:#fff;font-weight:900;text-decoration:none">
                  üîê Espace g√©rant
                </a>
              </div>
            </div>
          `, { maxWidth: 280 });

          markers.push(marker);
          boundsAll.push([lat, lng]);
        });

        updateCounts();

        if(fitBounds && boundsAll.length > 0){
          map.fitBounds(boundsAll, { padding:[40,40] });
        }
        setTimeout(() => map.invalidateSize(), 250);

        if(miniFollowed.classList.contains("open")) renderFollowedList();
        // ‚úÖ si recherche ouverte, rafra√Æchir r√©sultats (liste √† jour)
        if(miniSearch.classList.contains("open")) renderSearchResults();
      }catch(err){
        console.error(err);
        stationCountEl.textContent = "0";
        stationCountTopEl.textContent = "0";
        alert("Erreur lors du chargement des stations. V√©rifie /api/stations.geojson/");
      }
    }

    // Dropdown dependencies
    regionSelect.addEventListener('change', function() {
      const regionId = this.value || "";
      populateCercles(regionId, false);
      populateCommunes(regionId, cercleSelect.value || "", false);
    });

    cercleSelect.addEventListener('change', function() {
      const cercleId = this.value || "";
      if(!cercleId){
        populateCommunes(regionSelect.value || "", "", false);
        return;
      }
      const cercle = cerclesData.find(ce => String(ce.id) === String(cercleId));
      if(cercle && String(regionSelect.value || "") !== String(cercle.region_id)){
        regionSelect.value = String(cercle.region_id);
        populateCercles(regionSelect.value, true);
      }
      populateCommunes(regionSelect.value || "", cercleId, false);
    });

    communeSelect.addEventListener('change', function() {
      const communeId = this.value || "";
      if(!communeId) return;

      const commune = communesData.find(c => String(c.id) === String(communeId));
      if(!commune) return;

      const cercleId = String(commune.cercle_id);
      if(String(cercleSelect.value || "") !== cercleId){
        cercleSelect.value = cercleId;
      }

      const cercle = cerclesData.find(ce => String(ce.id) === String(cercleId));
      if(cercle && String(regionSelect.value || "") !== String(cercle.region_id)){
        regionSelect.value = String(cercle.region_id);
        populateCercles(regionSelect.value, true);
      }

      populateCommunes(regionSelect.value || "", cercleId, true);
    });

    // ‚úÖ Apply / Reset (panel filtres)
    document.getElementById('filtersForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      miniFilters.classList.remove('open');
      await reloadStationsFromApi({fitBounds: true});
    });

    document.getElementById('resetBtn').addEventListener('click', async () => {
      regionSelect.value = "";
      cercleSelect.value = "";
      communeSelect.value = "";
      statutSelect.value = "";

      populateCercles("", false);
      populateCommunes("", "", false);

      await reloadStationsFromApi({fitBounds: true});
    });

    // ‚úÖ Bouton "‚òÖ Suivies" depuis le panneau Filtres
    document.getElementById("openFollowedFromFilters").addEventListener("click", () => {
      miniFilters.classList.remove("open");
      openPanel(miniFollowed);
      renderFollowedList();
    });

    // ‚úÖ MENU TOPBAR wiring (compact)
    document.getElementById("filtersBtn").addEventListener("click", () => openPanel(miniFilters));
    document.getElementById("followedBtn").addEventListener("click", () => { openPanel(miniFollowed); renderFollowedList(); });
    document.getElementById("resetTopBtn").addEventListener("click", () => document.getElementById("resetBtn").click());

    // ============================
    // ‚úÖ Recherche (mini panneau)
    // ============================
    const searchInput = document.getElementById("searchInput");
    const searchResults = document.getElementById("searchResults");
    const searchCount = document.getElementById("searchCount");
    const searchGoBtn = document.getElementById("searchGoBtn");
    const searchClearBtn = document.getElementById("searchClearBtn");

    function stationSearchText(s){
      const parts = [];
      if(s.nom) parts.push(s.nom);
      if(s.commune) parts.push(s.commune);
      if(s.cercle) parts.push(s.cercle);
      if(s.region) parts.push(s.region);
      return normalize(parts.join(" "));
    }

    function renderSearchResults(){
      const q = normalize(searchInput.value);
      const all = Object.values(markerById)
        .map(m => m.__station)
        .filter(Boolean);

      let filtered = all;
      if(q.length >= 2){
        filtered = all.filter(s => stationSearchText(s).includes(q));
      }

      const max = 30;
      const shown = filtered.slice(0, max);

      searchCount.textContent = String(filtered.length);

      if(!shown.length){
        searchResults.innerHTML = `<div class="followed-empty">Aucun r√©sultat.</div>`;
        return;
      }

      searchResults.innerHTML = shown.map(s => `
        <div class="search-item">
          <div class="meta">
            <div class="name">${s.nom}</div>
            <div class="sub">${stationSubLine(s) || "-"}</div>
          </div>
          <button class="go" type="button" data-search-go="${s.id}">Voir</button>
        </div>
      `).join("");
    }

    function openSearch(){
      openPanel(miniSearch);
      setTimeout(() => searchInput.focus(), 60);
      renderSearchResults();
    }

    document.getElementById("searchBtn").addEventListener("click", openSearch);

    searchGoBtn.addEventListener("click", renderSearchResults);
    searchClearBtn.addEventListener("click", () => {
      searchInput.value = "";
      renderSearchResults();
      searchInput.focus();
    });

    // tape -> recherche auto
    searchInput.addEventListener("input", () => {
      clearTimeout(window.__searchT);
      window.__searchT = setTimeout(renderSearchResults, 120);
    });

    // clic sur r√©sultat -> centre + popup
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-search-go]");
      if(!btn) return;
      const id = String(btn.getAttribute("data-search-go"));
      const m = markerById[id];
      if(!m) return;
      miniSearch.classList.remove("open");
      map.setView(m.getLatLng(), 15, { animate: true });
      m.openPopup();
    });

    // ‚úÖ Bouton "centrer carte"
    const DEFAULT_CENTER = [12.65, -8.0];
    const DEFAULT_ZOOM = 6;
    document.getElementById("centerMapBtn").addEventListener("click", () => {
      if(boundsAll.length > 0){
        map.fitBounds(boundsAll, { padding:[40,40] });
      }else{
        map.setView(DEFAULT_CENTER, DEFAULT_ZOOM, { animate:true });
      }
    });

    // ‚úÖ Initial load
    document.addEventListener('DOMContentLoaded', async function() {
      if(selectedRegion) regionSelect.value = selectedRegion;
      populateCercles(selectedRegion, true);
      if(selectedCercle) cercleSelect.value = selectedCercle;
      populateCommunes(selectedRegion, selectedCercle, true);
      if(selectedCommune) communeSelect.value = selectedCommune;

      await reloadStationsFromApi({fitBounds: true});
    });
  </script>
</body>
</html>
