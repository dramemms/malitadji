<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte carburant Mali</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #map {
      height: 100vh;
      width: 100%;
    }

    .top-bar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 10px 14px;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }

    .filters {
      position: absolute;
      top: 70px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      width: 220px;
      font-size: 14px;
    }

    .filters label { font-weight: bold; }
    .filters select { width: 100%; margin: 4px 0 8px 0; }

    .filters button {
      width: 100%;
      background: #1e3a8a;
      color: white;
      border: none;
      padding: 6px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }

    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }

    .legend span {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
    }
  </style>
</head>

<body>

<div class="top-bar">
  üõ¢Ô∏è Disponibilit√© du carburant ‚Äî Bamako & R√©gions
</div>

<div class="filters">
  <form method="get">
    <label>R√©gion</label>
    <select name="region">
      <option value="">Toutes</option>
      {% for r in regions %}
      <option value="{{ r.id }}">{{ r.nom }}</option>
      {% endfor %}
    </select>

    <label>Commune</label>
    <select name="commune">
      <option value="">Toutes</option>
      {% for c in communes %}
      <option value="{{ c.id }}">{{ c.nom }}</option>
      {% endfor %}
    </select>

    <label>Statut</label>
    <select name="statut">
      <option value="">Tous</option>
      <option value="dispo">Disponible</option>
      <option value="faible">Faible</option>
      <option value="rupture">Rupture</option>
    </select>

    <button type="submit">Appliquer</button>
  </form>
</div>

<div id="map"></div>

<div class="legend">
  <div><span style="background:green"></span>Disponible</div>
  <div><span style="background:orange"></span>Faible</div>
  <div><span style="background:red"></span>Rupture</div>
  <div><span style="background:gray"></span>Inconnu</div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

// INIT MAP
var map = L.map('map').setView([12.65, -8.0], 11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

// DATA Django vers JS
var stations = JSON.parse('{{ stations_json|escapejs }}');

function getColor(essence, gasoil) {
  if (essence === 'rupture' || gasoil === 'rupture') return 'red';
  if (essence === 'faible' || gasoil === 'faible') return 'orange';
  if (essence === 'dispo' || gasoil === 'dispo') return 'green';
  return 'gray';
}

var bounds = [];

stations.forEach(function(s) {
  if (!s.lat || !s.lng) return;

  var color = getColor(s.super_statut, s.gasoil_statut);

  var marker = L.circleMarker([s.lat, s.lng], {
    radius: 7,
    color: color,
    fillColor: color,
    fillOpacity: 0.9
  }).addTo(map);

  marker.bindPopup(`
    <b>${s.nom}</b><br>
    R√©gion: ${s.region}<br>
    Cercle: ${s.cercle}<br>
    Commune: ${s.commune}<br><br>
    Super: ${s.super_statut || "-"}<br>
    Gasoil: ${s.gasoil_statut || "-"}<br><br>
    <a href="/manager/">üîê G√©rant</a>
  `);

  bounds.push([s.lat, s.lng]);
});

if (bounds.length > 0) {
  map.fitBounds(bounds, {padding:[30,30]});
}

</script>

</body>
</html>
